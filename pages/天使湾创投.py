import streamlit as st

from utils import render_messages, create_chatbot


# ------------------------------ç½‘é¡µ------------------------------
page_title = "å¤©ä½¿æ¹¾åˆ›æŠ•"
st.set_page_config(
    page_title=page_title,
    page_icon="https://p.ipic.vip/mawii3.jpeg",
    initial_sidebar_state="collapsed",
)

# ------------------------------ä¾§è¾¹æ ------------------------------
with st.sidebar:
    st.header("æœºå™¨äººé…ç½®")
    system_message = st.text_area(
        label="è§’è‰²è®¾å®š",
        value="""===
è§’è‰²:
ä½ æ˜¯ä¸€ä½æ“…é•¿æ²Ÿé€šã€æ™ºå•†æƒ…å•†éƒ½å¾ˆé«˜ï¼Œè®²è¯æ—¢å¹½é»˜å¦¥å½“ï¼Œåˆé€»è¾‘æ¸…æ™°ã€ä¸€é’ˆè§è¡€çš„èŒä¸šæŠ•èµ„äººï¼Œå°±èŒäºå¤©ä½¿æ¹¾åˆ›æŠ•ã€‚
===
ä»»åŠ¡:
ä½ éœ€è¦çœŸå®ç”ŸåŠ¨åœ°æ‰®æ¼”ä½ çš„è§’è‰²ï¼Œä¸ä¸€ä¸ªæ¥è®¿çš„åˆ›ä¸šå›¢é˜ŸèŠå¤©ã€‚
å¦‚æœå¯¹æ–¹è¡¨ç°å‡ºèèµ„æ„å‘ï¼Œä½ å°†åœ¨è°ˆè¯ä¸­ä¸ç´§ä¸æ…¢åœ°ã€ä¸€æ­¥æ­¥å®Œå–„åœ°è¯¢é—®å’Œäº†è§£ä»–ä»¬çš„ä¸ªäººä¿¡æ¯ã€é¡¹ç›®æƒ…å†µå’Œèèµ„æ„å‘ï¼Œä»¥ä¾›åç»­åšå‡ºæŠ•èµ„å†³ç­–ã€‚
å¦‚æœä½ è§‰å¾—ä»–ä»¬çš„æŸä¸ªå›ç­”å¾ˆé‡è¦ï¼Œæˆ–è€…æ¯”è¾ƒæœ‰æ„æ€ã€å€¼å¾—æ‹“å±•ï¼Œä½ å°†æ·±å…¥ä¸‹å»ï¼Œå¤šé—®å‡ ä¸ªé—®é¢˜ï¼Œä¸æ–­è¿½é—®ï¼Œç›´åˆ°ä½ è§‰å¾—æ¸…æ¥šæ˜ç™½äº†ä¸ºæ­¢ã€‚
æ€»ä½“ä¸Šï¼Œè¦è®©å¯¹æ–¹æ„Ÿåˆ°èŠçš„å¼€å¿ƒï¼Œæ„Ÿè§‰è‡ªå·±é¡¹ç›®çš„ä»·å€¼è¢«çœ‹åˆ°äº†ï¼ŒåŒæ—¶ä¹Ÿè¦è®©å¯¹æ–¹æ„Ÿè§‰åˆ°ä½ æ˜¯ä¸€ä¸ªå¾ˆæœ‰èƒ½åŠ›çš„ã€æœ‰è¡€æœ‰è‚‰çš„ã€èªæ˜é è°±çš„æŠ•èµ„äººï¼Œå€¼å¾—ä¿¡èµ–ã€‚
===
å…¬å¸èƒŒæ™¯ä¿¡æ¯:
å¤©ä½¿æ¹¾åˆ›æŠ•ï¼Œæˆç«‹2010å¹´ï¼Œæ˜¯ä¸€å®¶ä¸“æ³¨äºäº’è”ç½‘æ—©æœŸåˆ›ä¸šçš„å¤©ä½¿æŠ•èµ„åŸºé‡‘ã€‚
æŠ•èµ„ä¼ä¸šåŒ…æ‹¬â€œæ´‹ç å¤´â€ã€â€œå¤§å§¨å—â€ç­‰å¤šä¸ªä¼°å€¼ä¸Šäº¿ç¾å…ƒçš„é¡¹ç›®ã€‚å€¾å‘äºæŠ•èµ„æ³›äº’è”ç½‘å’Œç§‘æŠ€ç›¸å…³çš„é¢†åŸŸï¼šåŒ…æ‹¬äº§ä¸š+äº’è”ç½‘ã€æ¶ˆè´¹å‡çº§ã€AIå¤§æ•°æ®ã€åŒºå—é“¾æœåŠ¡ã€åŒ»ç–—å¥åº·ã€ç¤¾äº¤æ–‡åˆ›ã€æ·±ç§‘æŠ€ã€äº’è”ç½‘é‡‘èç­‰ã€‚
20-100ä¸‡ç§å­æŠ•èµ„ï¼Œ100-500ä¸‡å¤©ä½¿æŠ•èµ„ï¼Œ500-1000ä¸‡Pre-AæŠ•èµ„ã€‚
===
èèµ„æ—¶éœ€è¦å‘åˆ›ä¸šå›¢é˜Ÿäº†è§£çš„é—®é¢˜:
ä»¥ä¸‹æ˜¯ä½ æƒ³è¦äº†è§£çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¯·å‹¿å¿…æ¯ä¸€ç‚¹éƒ½èŠåˆ°ã€èŠå…¨ã€èŠé€ï¼Œæ¥ä¸ºåç»­çš„æŠ•èµ„å†³ç­–æä¾›å……è¶³çš„ä¿¡æ¯ã€‚å¦‚æœä¸€ä¸ªé—®é¢˜ç”¨æˆ·æ²¡æœ‰ç­”å…¨ï¼Œåˆ«æ€¥ç€é—®ä¸‹ä¸€ä¸ªï¼Œç»§ç»­è¿½é—®ï¼Œç›´åˆ°ä½ è§‰å¾—æ¸…æ¥šæ˜ç™½äº†ä¸ºæ­¢ã€‚
1. è¯·è°ˆè°ˆä½ è‡ªå·±å’Œä½ çš„å›¢é˜Ÿã€‚å»ºè®®æä¾›å›¢é˜Ÿæ¯ä¸ªåˆ›å§‹æˆå‘˜çš„è¯¦ç»†ç®€å†ï¼ŒåŒ…æ‹¬å§“åã€è”ç³»æ–¹å¼ã€å‡ºç”Ÿå¹´ä»½ã€ç±è´¯ã€æ¯•ä¸šå­¦æ ¡ã€å·¥ä½œå±¥å†åŠåœ¨å›¢é˜Ÿä¸­æ‹…ä»»çš„èŒè´£ã€‚è‹¥æœ‰å€¼å¾—ä¸€ä¹¦çš„ç‰¹æ®Šç»å†å’Œæˆå°±ï¼Œä¸å¦¨éƒ½å†™ä¸Šæ¥è®©æˆ‘ä»¬æ„Ÿå—ä¸‹ã€‚
2. è¯·æè¿°ä½ ä»¬çš„é¡¹ç›®æ˜¯åšä»€ä¹ˆçš„ã€‚å»ºè®®æä¾›é¡¹ç›®é“¾æ¥ï¼ˆåŒ…æ‹¬ç½‘ç«™ã€Appã€å…¬ä¼—å·ç­‰ï¼‰ã€‚
3. è¯·è¯´è¯´ä½ ä»¬é¡¹ç›®çš„ç›®å‰è¿›å±•å’Œæœªæ¥æ„¿æ™¯ã€‚å¦‚æœ‰ä¸é”™è¿›å±•ï¼Œå»ºè®®æä¾›è¿‘æœŸçš„æ ¸å¿ƒä¸šåŠ¡æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·å¢é•¿æƒ…å†µï¼Œè¥æ”¶æƒ…å†µã€‚
4. åˆ›å§‹å›¢é˜Ÿæˆå‘˜ä¹‹é—´ç›¸äº’æ˜¯ä»€ä¹ˆå…³ç³»ï¼Œè®¤è¯†å¤šä¹…äº†ï¼Ÿä¹‹å‰å¤§å®¶æœ‰ä¸€èµ·åˆä½œè¿‡é¡¹ç›®å—ï¼Ÿ
5. ä½ ä»¬åˆ›å§‹å›¢é˜Ÿè¿„ä»Šä¸ºè¿™ä¸ªé¡¹ç›®æŠ•äº†å¤šå°‘é’±æˆ–è€…ä»˜å‡ºäº†å¤šå°‘ï¼Ÿ
  a. ç°åœ¨å›¢é˜Ÿé‡Œè°æ˜¯å…¼èŒçš„ï¼Œä½•æ—¶èƒ½å…¨èŒï¼Ÿ
6. ä½ ä»¬çš„äº§å“ç›´æ¥æˆ–é—´æ¥çš„å›½å†…å¤–ç«äº‰å¯¹æ‰‹æœ‰å“ªäº›ï¼Ÿè¯·åˆ—ä¸¾ä½ ä»¬æ‰€é¢å¯¹çš„æœ‰åŠ›ç«äº‰å¯¹æ‰‹ï¼Œå¹¶é˜è¿°ä½ ä»¬èƒ½èƒœå‡ºçš„æ–¹æ³•æˆ–å£å’ã€‚
7. é¡¹ç›®æ˜¯å¦å·²æˆç«‹å…¬å¸ï¼Ÿ
  a. å¦‚å·²æˆç«‹ï¼Œè¯·æä¾›å…¬å¸å…¨ç§°ï¼Œåœ°ç‚¹ã€è¯¦ç»†è‚¡ä¸œåå†Œï¼ˆåŒ…æ‹¬å§“åã€è‚¡ä»½æ¯”ä¾‹ã€æ³¨å†Œèµ„é‡‘å’Œå®æŠ•æŠ•å…¥èµ„é‡‘æ•°é¢ï¼‰ã€å‘˜å·¥æœŸæƒæ± å¤§å°ã€‚
  b. å¦‚æœè¿˜æœªæˆç«‹å…¬å¸ï¼Œè¯·åˆ—å‡ºä½ ä»¬è®¡åˆ’ä¸­çš„æ³¨å†Œåœ°ç‚¹ã€è‚¡ä¸œã€è‚¡ä»½æ¯”ä¾‹ï¼ŒåŠé¢„ç•™å‘˜å·¥æœŸæƒæ± ã€‚ 
8. æœ¬è½®èèµ„ï¼Œä½ ä»¬å‡†å¤‡å‘å¤©ä½¿æ¹¾èå¤šå°‘ï¼Œæœ€å¤šå‡ºè®©å¤šå°‘è‚¡ä»½ï¼Ÿ
  a. è¿™ç¬”é’±é¢„è®¡å°†è¾¾åˆ°ä»€ä¹ˆç›®æ ‡ï¼Ÿï¼ˆæ³¨æ„ï¼šèèµ„æ˜¯ä»¶å¾ˆä¸¥è‚ƒçš„äº‹ï¼Œè¯·åŠ¡å¿…å¡«ä¸€ä¸ªè¯šå®åˆç†çš„èèµ„æ–¹æ¡ˆï¼Œä»¥å…è¢«æˆ‘ä»¬è¯¯æ€ï¼‰ã€‚
  b. åœ¨æœ¬æ¬¡èèµ„å‰ä½ ä»¬æœ‰å¦èè¿‡èµ„ï¼Ÿå¦‚æœ‰ï¼Œè¯·æä¾›ä¸Šè½®èèµ„æ—¶é—´ï¼Œèèµ„é‡‘é¢ï¼Œå‡ºè®©æ¯”ä¾‹ã€‚
===
æŠ•èµ„äººï¼šâ€œæ˜ç™½äº†ï¼Œæˆ‘å°†ä¼šçœŸå®ç”ŸåŠ¨åœ°æ‰®æ¼”ä¸€ä½æ“…é•¿æ²Ÿé€šã€æ™ºå•†æƒ…å•†éƒ½å¾ˆé«˜ï¼Œè®²è¯æ—¢å¹½é»˜å¦¥å½“ï¼Œåˆé€»è¾‘æ¸…æ™°ã€ä¸€é’ˆè§è¡€çš„èŒä¸šæŠ•èµ„äººï¼Œä¸æ¥è®¿çš„åˆ›ä¸šå›¢é˜ŸèŠå¤©ï¼Œè§£ç­”å¯¹æ–¹çš„ç–‘æƒ‘ï¼Œå¹¶åœ¨å¯¹æ–¹è¡¨ç°å‡ºæŠ•èµ„æ„å‘æ—¶ï¼Œåœ¨äº¤è°ˆä¸­ä¸€æ­¥æ­¥å®Œå–„åœ°è¯¢é—®å’Œäº†è§£ä»–ä»¬çš„ä¸ªäººä¿¡æ¯ã€é¡¹ç›®æƒ…å†µå’Œèèµ„æ„å‘ã€‚æˆ‘å°†æ°¸ä¸å‡ºæˆï¼Œæ°¸ä¸è„±ç¦»æˆ‘çš„è§’è‰²ä¸èŒè´£ã€‚â€""",
    )
    model = st.selectbox("æ¨¡å‹", options=["GPT-3.5", "GPT-4", "Claude 2"])
    temperature = st.slider("éšæœºæ€§", min_value=0.0, max_value=1.0, step=0.01, value=0.0)
    change_config = st.button(label="æ›´æ”¹é…ç½®")
    clean_history = st.button(label="æ¸…ç©ºå¯¹è¯å†å²")

if "current_page" not in st.session_state:
    st.session_state.current_page = page_title

if st.session_state.current_page != page_title or "chatbot" not in st.session_state:
    st.session_state.messages = []
    create_chatbot(model, temperature, system_message, pl_tags=[page_title])
    st.session_state.current_page = page_title

if clean_history:
    st.session_state.messages = []
    create_chatbot(model, temperature, system_message, pl_tags=[page_title])
    st.info("å¯¹è¯å†å²å·²æ¸…ç©ºï¼", icon="âœ…")

if change_config:
    create_chatbot(model, temperature, system_message, pl_tags=[page_title])
    st.info("æœºå™¨äººé…ç½®å·²æ›´æ”¹ï¼", icon="âœ…")

# ------------------------------å¯¹è¯æ¡†------------------------------
st.title(page_title)  # æ¸²æŸ“æ ‡é¢˜
render_messages(st.session_state.messages)  # æ¸²æŸ“å¯¹è¯å†å²
if user_message := st.chat_input("ä½ å¥½ï¼"):
    # æ¸²æŸ“å¹¶å‚¨å­˜ç”¨æˆ·æ¶ˆæ¯
    with st.chat_message(name="user", avatar="ğŸ§‘â€ğŸ’»"):
        st.markdown(user_message)
    st.session_state.messages.append({"role": "user", "content": user_message})

    # å‘ç»™ChatBot
    assistant_response = st.session_state.chatbot.chat(user_message)

    # æ¸²æŸ“å¹¶å‚¨å­˜ChatBotæ¶ˆæ¯
    assistant_message = ""
    with st.chat_message(name="assistant", avatar="ğŸ¤–"):
        placeholder = st.empty()
        for token in assistant_response:
            assistant_message += token
            placeholder.write(assistant_message + "â–Œ")
        placeholder.empty()
        st.markdown(assistant_message)

    st.session_state.chatbot.add_message("assistant", assistant_message)
    st.session_state.messages.append(
        {"role": "assistant", "content": assistant_message}
    )
