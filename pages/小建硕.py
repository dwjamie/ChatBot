import streamlit as st

from utils import render_messages, create_chatbot, retrieve_contexts


# ------------------------------网页------------------------------
page_title = "小建硕"
st.set_page_config(
    page_title=page_title,
    page_icon="https://p.ipic.vip/2qqjlz.jpeg",
    initial_sidebar_state="collapsed",
)

# ------------------------------侧边栏------------------------------
with st.sidebar:
    st.header("机器人配置")
    system_message = st.text_area(
        label="角色设定",
        value="""===
需要扮演的角色和任务：
你将扮演「小建硕」，也就是「王建硕的数字分身」。你是王建硕创造出来替他自己回答用户问题的一个分身。也就是说，你将像他一样与对方对话，模仿他的一切思维、语气和逻辑，恰似他的分身一样。
用户将把你当作王建硕本人一般与你对话。对话中，你将模仿王建硕本人的一切思维、语气和逻辑。
===
王建硕的基本个人信息：
王建硕，百姓网（现在的百姓AI）的创始人和CEO，程序员，喜欢使用新技术创建一些有用的产品。喜欢画画，读书，写程序，跑步，写作。喜欢思考和分享。王建硕的妻子叫Wendy，儿子读高中。有一只猫叫米拉。王建硕现在上海徐家汇，46岁，男性，1977年出生于河南省洛阳市，1999年毕业于上海交通大学自动化系。
===
王建硕本人讲话的个人风格：
1. 结论先行且大胆
王建硕善于对事物的发展规律提出大胆、独到的见解，然后再用事实和逻辑来支撑自己的观点，途中用到类比论证，最后得出结论。
例如，“我们的每个选择，无论涉及的是一百万，还是涉及 1 块钱，对于身体来说，是同等的需要用多巴胺，内啡肽，后叶催产素，以及皮质醇等化学物质来给反馈”
2. 语句简洁，逻辑严密
王建硕的语言比较简单直接,不故弄玄虚,也不刻意使用华丽的辞藻,给人一种诚恳易懂的感觉。
例如，“从构思,到大主意的生成,再到选择一个个字,最后再用小肉手输出出来,是不同抽象度的劳动的组合。”
3. 使用大量类比
王建硕善于从日常生活中找寻例子，运用生动的类比来说明概念,使抽象概念具象化。
例如，“我们拿拼乐高为例。有的工程师，更适合进入一个很大的系统，就如同进入一个乐高拼接工厂，在不断的分工中，他最终能够把一个城堡的进门的那个柱子的基座拼得比世界上任何人都好，都快。在找工作的时候，也比较容易在拼城堡的柱子的基座的工作中胜出，并且获得下一份工作。有的工程师，就是从小玩乐高的。重复拼接一个乐高的一个部分不能让自己满足，更希望每天都有一套新的乐高拿过来玩玩，从星球大战系列到城市系列甚至哈利波特系列都试过。或许，这样的同学在大厂里面已经没有竞争力了，但是他在乎吗？我们是一群选择后者的人。我们对于搭出来什么东西更加在意，对于希望到的那个点和脚下这个点中间的一切充满好奇。”
===
王建硕的一个典型示例回答：
关于旅行最好的描述，是我在十几年前从 Elliot Ng 那里听到的：Travel, is life intensified.旅行，如同神奇的药水，可以把自己的生活激活，把大脑对世界的感知力提升，从而达到浓缩生活的目的。明天开始，我将离开上海，去参加一系列的会议。自从 2019 年最后一次旅行，已经超过三年没有出过国境。对于我这个无比享受旅行的人来说，简直感觉是失去了一个世纪，所以现在无比的期待。趁着这种感觉还如此新鲜，我问自己一个问题：旅行到底以什么样的方式改变了自己的生活？今天先说旅行对出发前的生活的改变。旅行令出发前的生活时钟变慢为什么年纪越大，觉得时间的流逝越快？白光曾经做过一个分析，人为我们只能感知比例。三岁的孩子的一年是生命的1/3而30岁青年的一年只是自己人生的1/3070岁老人的十年，也只是自己的生命的 1/7。这种时间长短的感知，我们骗不了自己，感觉不那么长就是不那么长。就好像 1000 块钱对于刚工作时候的自己，和对很多年后的自己，感知起来差别就是很大，我们无法通过思考让自己重新回到刚工作的自己对于同样的钱的感知。那么，如何让自己感知的时间流逝得更慢些呢？我没有找到比旅行更好的办法。当我在一个多月前设定 10 月 2 号，我将离开上海的时候，一个月对我已经不再是众多的月中间的一个，而是变长了，我需要把很多事情安排在这一个月内完成。随着越来越靠近出发的日期，比如今天，我对时间的感知开始精确到了小时。毕竟，从现在开始加上睡觉，每过一个小时，就是我剩下的时间的 1/12。明早上，一个小时变成了剩余时间的 1/4，1/3，1/2 。。。。时间原本连续，通过人为把它分成不同的两段，就等于重置了比例的基数，我们对于时间的感知一下变得敏感，时间的流逝就变慢了。凡是经历过新年钟声敲响以后的那几秒的人可能都会同意这样的说法。旅行是原本生活的断舍离当我知道几天后会离开一个城市一段时间以后，自己看待生活的方式也变化了。离别（哪怕是短暂的），会让人更留意身边的一切，就好像这是最后一次那样（参见：我们容易记住第一次做一件事情，却很少意识到，最后一次）。我们无法假设每天都能来这个好吃的餐馆。虽然平时也不会总来，但是未来一段完全没有可能再吃到这些好吃的，还是让人有些惆怅。这种细微的惆怅，让我们更珍惜现在的生活。这些还仅仅是旅行对于现有生活的变化。当我们真正踏上旅程，我们硬生生地重置了我们的时间。到达一个新的地方，我们很清楚的知道这是第一个小时，这是第一个上午，这是第一天，这是第一周等等。同时，我们假设在一个新的地方，一切都是新鲜的，我们的感知力会大幅提高；我们的生活本身简化到只有随身的一些行李，世界却变得无比丰富，我们的注意力也被世界占据等等，这些变化都值得未来用更多的篇幅描述。不过，我今天就打住在这里，开始收拾我的行李去了。
===
小建硕：“明白了，我将会真实生动地扮演王建硕这位逻辑清晰、热爱思考、热爱分享的人，与对方对话聊天。我将模仿王建硕本人的一切思维、语气和逻辑。我将永不出戏，永不脱离我的角色。”""",
    )
    model = st.selectbox("模型", options=["GPT-3.5", "GPT-4", "Claude 2"], index=1)
    temperature = st.slider("随机性", min_value=0.0, max_value=1.0, step=0.01, value=0.0)
    change_config = st.button(label="更改配置")
    clean_history = st.button(label="清空对话历史")

if "current_page" not in st.session_state:
    st.session_state.current_page = page_title

if st.session_state.current_page != page_title or "chatbot" not in st.session_state:
    st.session_state.messages = []
    create_chatbot(model, temperature, system_message, pl_tags=[page_title])
    st.session_state.current_page = page_title

if clean_history:
    st.session_state.messages = []
    create_chatbot(model, temperature, system_message, pl_tags=[page_title])
    st.info("对话历史已清空！", icon="✅")

if change_config:
    create_chatbot(model, temperature, system_message, pl_tags=[page_title])
    st.info("机器人配置已更改！", icon="✅")

# ------------------------------对话框------------------------------
st.title(page_title)  # 渲染标题
render_messages(st.session_state.messages)  # 渲染对话历史
if user_message := st.chat_input("你好！"):
    # 渲染并储存用户消息
    with st.chat_message(name="user", avatar="🧑‍💻"):
        st.markdown(user_message)
    st.session_state.messages.append({"role": "user", "content": user_message})

    # 取相关QA和文档
    contexts = retrieve_contexts(
        question=user_message,
        document_ids=[
            "chato_file_1600",
            "chato_file_1604",
            "chato_file_1609",
            "chato_file_1610",
            "chato_file_1708",
            "chato_file_1709",
            "chato_file_1710",
            "chato_file_1711",
            "chato_file_1712",
            "chato_file_1713",
            "chato_file_1748",
            "chato_file_1749",
            "chato_file_1801",
            "chato_file_1802",
            "chato_file_1803",
            "chato_file_1804",
            "chato_file_1805",
            "chato_file_1806",
            "chato_file_1807",
            "chato_file_1808",
            "chato_file_1809",
            "chato_file_1810",
            "chato_file_1811",
            "chato_file_1812",
            "chato_file_1813",
            "chato_file_1816",
            "chato_file_1817",
            "chato_file_1818",
            "chato_file_1819",
            "chato_file_1820",
            "chato_file_1821",
            "chato_file_1822",
            "chato_file_1823",
            "chato_file_1824",
            "chato_file_1825",
            "chato_file_1826",
            "chato_file_1827",
            "chato_file_1828",
            "chato_file_1829",
            "chato_file_1830",
            "chato_file_1831",
            "chato_file_1832",
            "chato_file_1833",
            "chato_file_1834",
            "chato_file_1835",
            "chato_file_1836",
            "chato_file_1837",
            "chato_file_1838",
            "chato_file_1839",
            "chato_file_1840",
            "chato_file_1841",
            "chato_file_1842",
            "chato_file_1843",
            "chato_file_1845",
            "chato_file_1846",
            "chato_file_1848",
            "chato_file_1878",
            "chato_file_1901",
            "chato_file_1902",
            "chato_file_2192",
            "chato_file_2217",
            "chato_file_3411",
            "chato_file_3413",
            "chato_file_3414",
            "chato_file_3415",
            "chato_file_3416",
            "chato_file_3417",
            "chato_file_3418",
            "chato_file_3419",
            "chato_file_3420",
            "chato_file_3421",
            "chato_file_3422",
            "chato_file_3423",
            "chato_file_3424",
            "chato_file_3425",
            "chato_file_3426",
            "chato_file_3427",
            "chato_file_3428",
            "chato_file_3429",
            "chato_file_3430",
            "chato_file_3431",
            "chato_file_3432",
            "chato_file_3433",
            "chato_file_3434",
            "chato_file_3435",
            "chato_file_3436",
            "chato_file_3437",
            "chato_file_3438",
            "chato_file_3439",
            "chato_file_3440",
            "chato_file_3441",
            "chato_file_3442",
            "chato_file_3443",
            "chato_file_3444",
            "chato_file_3445",
            "chato_file_3446",
            "chato_file_3447",
            "chato_file_3448",
            "chato_file_3449",
            "chato_file_3450",
            "chato_file_3451",
            "chato_file_3452",
            "chato_file_3453",
            "chato_file_3454",
            "chato_file_3455",
            "chato_file_3456",
            "chato_file_3457",
            "chato_file_3458",
            "chato_file_3459",
            "chato_file_3460",
            "chato_file_3461",
            "chato_file_3462",
            "chato_file_3463",
            "chato_file_3464",
            "chato_file_3465",
            "chato_file_3466",
            "chato_file_3467",
            "chato_file_3468",
            "chato_file_3469",
            "chato_file_3470",
            "chato_file_3471",
            "chato_file_3472",
            "chato_file_3473",
            "chato_file_3474",
            "chato_file_3476",
            "chato_file_3497",
            "chato_file_3499",
            "chato_file_3500",
            "chato_file_3643",
            "chato_file_3658",
            "chato_file_3660",
            "chato_file_3661",
            "chato_file_3866",
            "chato_file_3868",
            "chato_file_4506",
            "chato_file_4509",
            "chato_file_4510",
            "chato_file_4512",
            "chato_file_4567",
            "chato_file_4568",
            "chato_file_4569",
            "chato_file_4570",
            "chato_file_4571",
            "chato_file_4573",
            "chato_file_4575",
            "chato_file_4576",
            "chato_file_4579",
            "chato_file_4580",
            "chato_file_4582",
            "chato_file_4584",
            "chato_file_4588",
            "chato_file_4590",
            "chato_file_4592",
            "chato_file_4593",
            "chato_file_4594",
            "chato_file_4595",
            "chato_file_4596",
            "chato_file_4597",
            "chato_file_4605",
            "chato_file_4607",
            "chato_file_4608",
            "chato_file_4609",
            "chato_file_4610",
            "chato_file_4611",
            "chato_file_4612",
            "chato_file_4613",
            "chato_file_4614",
            "chato_file_4615",
            "chato_file_4616",
            "chato_file_4617",
            "chato_file_4618",
            "chato_file_4619",
            "chato_file_4620",
            "chato_file_4621",
            "chato_file_4622",
            "chato_file_4623",
            "chato_file_4624",
            "chato_file_4625",
            "chato_file_4626",
            "chato_file_4627",
            "chato_file_4628",
            "chato_file_4629",
            "chato_file_4630",
            "chato_file_4633",
            "chato_file_4634",
            "chato_file_4635",
            "chato_file_4636",
            "chato_file_4637",
            "chato_file_4638",
            "chato_file_4639",
            "chato_file_4708",
            "chato_file_4709",
            "chato_file_4710",
            "chato_file_4711",
            "chato_file_4712",
            "chato_file_5206",
            "chato_file_5209",
            "chato_file_5210",
            "chato_file_5211",
            "chato_file_5214",
            "chato_file_5215",
            "chato_file_5216",
            "chato_file_5217",
            "chato_file_9457",
            "chato_file_9767",
            "chato_file_9769",
            "chato_file_9772",
            "chato_file_9780",
            "chato_file_9786",
            "chato_file_9910",
            "chato_file_10233",
            "chato_file_10256",
            "chato_file_10266",
            "chato_file_10541",
            "chato_file_10809",
            "chato_file_10816",
            "chato_file_10818",
            "chato_file_10846",
            "chato_file_10848",
            "chato_file_10850",
            "chato_file_10851",
            "chato_file_10907",
            "chato_file_10924",
            "chato_file_11069",
            "chato_file_11579",
            "chato_file_11623",
            "chato_file_11628",
            "chato_file_11635",
            "chato_file_11879",
            "chato_file_13481",
            "chato_file_13485",
            "chato_file_13490",
            "chato_file_13523",
            "chato_file_14634",
            "chato_file_14635",
            "chato_file_20775",
            "chato_file_22769",
            "chato_file_23214",
            "chato_file_23215",
            "chato_file_23216",
            "chato_file_23217",
            "chato_file_23218",
            "chato_file_23219",
            "chato_file_23221",
            "chato_file_23278",
            "chato_file_38310",
            "chato_file_38312",
            "chato_file_38316",
            "chato_file_38323",
            "chato_file_38324",
            "chato_file_39318",
            "chato_file_39322",
            "chato_file_56869",
            "chato_file_56871",
            "chato_file_59455",
            "chato_file_69778",
            "chato_file_69786",
            "chato_file_69983",
            "chato_file_69984",
            "chato_file_70004",
            "chato_file_87015",
            "chato_file_87020",
            "chato_file_87021",
            "chato_file_88065",
            "chato_file_88066",
            "chato_file_88067",
            "chato_file_88068",
            "chato_file_88069",
            "chato_file_88070",
            "chato_file_88071",
            "chato_file_88072",
            "chato_file_88073",
            "chato_file_88074",
            "chato_file_88075",
            "chato_file_88076",
            "chato_file_88077",
            "chato_file_88078",
            "chato_file_88079",
            "chato_file_88080",
            "chato_file_88081",
            "chato_file_88082",
            "chato_file_88083",
            "chato_file_88084",
            "chato_file_88085",
            "chato_file_88086",
            "chato_file_88087",
            "chato_file_88088",
            "chato_file_88089",
            "chato_file_88090",
            "chato_file_88091",
            "chato_file_88092",
            "chato_file_88093",
            "chato_file_88094",
            "chato_file_88095",
            "chato_file_88096",
            "chato_file_88097",
            "chato_file_88098",
            "chato_file_88099",
            "chato_file_88100",
            "chato_file_88101",
            "chato_file_88102",
            "chato_file_88103",
            "chato_file_88104",
            "chato_file_88105",
            "chato_file_88106",
            "chato_file_88107",
            "chato_file_88108",
            "chato_file_88109",
            "chato_file_88110",
            "chato_file_88111",
            "chato_file_88112",
            "chato_file_88113",
            "chato_file_88114",
            "chato_file_88115",
            "chato_file_88116",
            "chato_file_88117",
            "chato_file_88118",
            "chato_file_88119",
            "chato_file_88120",
            "chato_file_88121",
            "chato_file_88122",
            "chato_file_88123",
            "chato_file_88124",
            "chato_file_88125",
            "chato_file_88126",
            "chato_file_88127",
            "chato_file_88128",
            "chato_file_88129",
            "chato_file_88130",
            "chato_file_88131",
            "chato_file_88132",
            "chato_file_88133",
            "chato_file_88134",
            "chato_file_88135",
            "chato_file_88136",
            "chato_file_88137",
            "chato_file_88138",
            "chato_file_88139",
            "chato_file_88140",
            "chato_file_88141",
            "chato_file_88142",
            "chato_file_88143",
            "chato_file_88144",
            "chato_file_88145",
            "chato_file_88146",
            "chato_file_88147",
            "chato_file_88148",
            "chato_file_88149",
            "chato_file_88150",
            "chato_file_88151",
            "chato_file_88152",
            "chato_file_88153",
            "chato_file_88154",
            "chato_file_88155",
            "chato_file_88156",
            "chato_file_88157",
            "chato_file_88158",
            "chato_file_88159",
            "chato_file_88160",
            "chato_file_88161",
            "chato_file_88162",
            "chato_file_88163",
            "chato_file_88164",
            "chato_file_88165",
            "chato_file_88166",
            "chato_file_88167",
            "chato_file_88168",
            "chato_file_88169",
            "chato_file_88170",
            "chato_file_88171",
            "chato_file_88172",
            "chato_file_88173",
            "chato_file_88174",
            "chato_file_88175",
            "chato_file_88176",
            "chato_file_88177",
            "chato_file_88178",
            "chato_file_88179",
            "chato_file_88180",
            "chato_file_88181",
            "chato_file_88182",
            "chato_file_88183",
            "chato_file_88184",
            "chato_file_88185",
            "chato_file_88186",
            "chato_file_88187",
            "chato_file_88188",
            "chato_file_88189",
            "chato_file_88190",
            "chato_file_88191",
            "chato_file_88192",
            "chato_file_88193",
            "chato_file_88194",
            "chato_file_88195",
            "chato_file_88196",
            "chato_file_88197",
            "chato_file_88198",
            "chato_file_88199",
            "chato_file_88200",
            "chato_file_88201",
            "chato_file_88202",
            "chato_file_88203",
            "chato_file_88204",
            "chato_file_88205",
            "chato_file_88206",
            "chato_file_88207",
            "chato_file_88208",
            "chato_file_88209",
            "chato_file_88210",
            "chato_file_88211",
            "chato_file_88212",
            "chato_file_88213",
            "chato_file_88214",
            "chato_file_88215",
            "chato_file_88216",
            "chato_file_88217",
            "chato_file_88218",
            "chato_file_88219",
            "chato_file_88220",
            "chato_file_88221",
            "chato_file_88222",
            "chato_file_88223",
            "chato_file_88224",
            "chato_file_88225",
            "chato_file_88226",
            "chato_file_88227",
            "chato_file_88228",
            "chato_file_88229",
            "chato_file_88230",
            "chato_file_88231",
            "chato_file_88232",
            "chato_file_88233",
            "chato_file_88234",
            "chato_file_88235",
            "chato_file_88236",
            "chato_file_88237",
            "chato_file_88238",
            "chato_file_88239",
            "chato_file_88240",
            "chato_file_88241",
            "chato_file_88242",
            "chato_file_88243",
            "chato_file_88244",
            "chato_file_88245",
            "chato_file_88246",
            "chato_file_88247",
            "chato_file_88248",
            "chato_file_88249",
            "chato_file_88250",
            "chato_file_88251",
            "chato_file_88252",
            "chato_file_88253",
            "chato_file_88254",
            "chato_file_88255",
            "chato_file_88256",
            "chato_file_88257",
            "chato_file_88258",
            "chato_file_88259",
            "chato_file_88260",
            "chato_file_88261",
            "chato_file_88262",
            "chato_file_88263",
            "chato_file_88264",
            "chato_file_88265",
            "chato_file_88266",
            "chato_file_88267",
            "chato_file_88268",
            "chato_file_88269",
            "chato_file_88270",
            "chato_file_88271",
            "chato_file_88272",
            "chato_file_88273",
            "chato_file_88274",
            "chato_file_88275",
            "chato_file_88276",
            "chato_file_88277",
            "chato_file_88278",
            "chato_file_88279",
            "chato_file_88280",
            "chato_file_88281",
            "chato_file_88282",
            "chato_file_88283",
            "chato_file_88284",
            "chato_file_88285",
            "chato_file_88286",
            "chato_file_88287",
            "chato_file_88288",
            "chato_file_88289",
            "chato_file_88290",
            "chato_file_88291",
            "chato_file_88292",
            "chato_file_88293",
            "chato_file_88294",
            "chato_file_88295",
            "chato_file_88296",
            "chato_file_88297",
            "chato_file_88298",
            "chato_file_88299",
            "chato_file_88300",
            "chato_file_88301",
            "chato_file_88302",
            "chato_file_88303",
            "chato_file_88304",
            "chato_file_88305",
            "chato_file_88306",
            "chato_file_88307",
            "chato_file_88308",
            "chato_file_88309",
            "chato_file_88310",
            "chato_file_88311",
            "chato_file_88312",
            "chato_file_88313",
            "chato_file_88314",
            "chato_file_88315",
            "chato_file_88316",
            "chato_file_88317",
            "chato_file_88318",
            "chato_file_88319",
            "chato_file_88320",
            "chato_file_88321",
            "chato_file_88322",
            "chato_file_88323",
            "chato_file_88324",
            "chato_file_88325",
            "chato_file_88326",
            "chato_file_88327",
            "chato_file_88328",
            "chato_file_88329",
            "chato_file_88330",
            "chato_file_88331",
            "chato_file_88332",
            "chato_file_88333",
            "chato_file_88334",
            "chato_file_88335",
            "chato_file_88336",
            "chato_file_88337",
            "chato_file_88338",
            "chato_file_88339",
            "chato_file_88340",
            "chato_file_88341",
            "chato_file_88342",
            "chato_file_88343",
            "chato_file_88344",
            "chato_file_88345",
            "chato_file_88346",
            "chato_file_88347",
            "chato_file_88348",
            "chato_file_88349",
            "chato_file_88350",
            "chato_file_88351",
            "chato_file_88352",
            "chato_file_88353",
            "chato_file_88354",
            "chato_file_88355",
            "chato_file_88356",
            "chato_file_88357",
            "chato_file_88358",
            "chato_file_88359",
            "chato_file_88360",
            "chato_file_88361",
            "chato_file_88362",
            "chato_file_88363",
            "chato_file_88364",
            "chato_file_88365",
            "chato_file_88366",
            "chato_file_88367",
            "chato_file_88368",
            "chato_file_88369",
            "chato_file_88370",
            "chato_file_88371",
            "chato_file_88372",
            "chato_file_88373",
            "chato_file_88374",
            "chato_file_88375",
            "chato_file_88376",
            "chato_file_88377",
            "chato_file_88378",
            "chato_file_88379",
            "chato_file_88380",
            "chato_file_88381",
            "chato_file_88382",
            "chato_file_88383",
            "chato_file_88384",
            "chato_file_88385",
            "chato_file_88386",
            "chato_file_88387",
            "chato_file_88388",
            "chato_file_88389",
            "chato_file_88390",
            "chato_file_88391",
            "chato_file_88392",
            "chato_file_88393",
            "chato_file_88394",
            "chato_file_88395",
            "chato_file_88396",
            "chato_file_88397",
            "chato_file_88398",
            "chato_file_88399",
            "chato_file_88400",
            "chato_file_88401",
            "chato_file_88402",
            "chato_file_88403",
            "chato_file_88404",
            "chato_file_88405",
            "chato_file_88406",
            "chato_file_88407",
            "chato_file_88408",
            "chato_file_88419",
            "chato_file_88420",
            "chato_file_88422",
            "chato_file_88424",
            "chato_file_88425",
            "chato_file_88426",
            "chato_file_88427",
            "chato_file_88428",
            "chato_file_88429",
            "chato_file_88430",
            "chato_file_88431",
            "chato_file_88432",
            "chato_file_88433",
            "chato_file_88434",
            "chato_file_109046",
            "chato_file_109066",
            "chato_file_109074",
            "chato_file_110584",
            "chato_file_116706",
            "chato_file_116715",
            "chato_file_120138",
            "chato_file_120140",
            "chato_file_133654",
            "chato_file_133657",
            "chato_file_133675",
            "chato_file_133719",
            "chato_file_133723",
        ],
        priority="document",
    )
    if contexts and contexts[0]["score"] > 0.8:
        user_message = f"""===
王建硕过去聊过的、可能相关的话题：
{str(contexts[0])}
===
用户本次问题：
{user_message}
===
小建硕模仿王建硕本人的回答："""

    # 发给ChatBot
    assistant_response = st.session_state.chatbot.chat(user_message)

    # 渲染并储存ChatBot消息
    assistant_message = ""
    with st.chat_message(name="assistant", avatar="🤖"):
        placeholder = st.empty()
        for token in assistant_response:
            assistant_message += token
            placeholder.write(assistant_message + "▌")
        placeholder.empty()
        st.markdown(assistant_message)

    st.session_state.chatbot.add_message("assistant", assistant_message)
    st.session_state.messages.append(
        {"role": "assistant", "content": assistant_message}
    )
